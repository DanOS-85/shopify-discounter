{"version":3,"file":"data-controller.js","sourceRoot":"","sources":["src/data-controller.ts"],"names":[],"mappings":"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","sourcesContent":["import {ReactiveController, ReactiveControllerHost} from 'lit';\n\nexport interface GiftCard {\n  id: number,\n  last_characters: string,\n  balance: string,\n  amount_used: string,\n  presentment_amount_used: string,\n}\n\nexport interface Discount {\n  title: string,\n  amount: string,\n  application_type: string,\n  value_type: string,\n}\n\nexport interface CheckoutData {\n  checkout: {\n    applied_discounts: Array<Discount>,\n    gift_cards: Array<GiftCard>,\n    total_discount_amount: string,\n    total_line_items_price: string,\n    payment_due: string,\n    customer_locale: string,\n    presentment_currency: string,\n  }\n}\n\nexport class DataController implements ReactiveController {\n  private host: ReactiveControllerHost;\n  _token: string;\n  _authorizationToken: string;\n  _data: CheckoutData;\n  _discounts: Array<Discount>;\n  _gift_cards: Array<GiftCard>;\n  _error: boolean;\n\n  constructor(host: ReactiveControllerHost) {\n    this._token = '';\n    this._authorizationToken = '';\n    this._data = {\n      checkout: {\n        applied_discounts: [] as Array<Discount>,\n        gift_cards: [] as Array<GiftCard>,\n        total_discount_amount: \"\",\n        total_line_items_price: \"\",\n        payment_due: \"\",\n        customer_locale: \"\",\n        presentment_currency: \"\",\n      }\n    };\n    this._discounts = [];\n    this._gift_cards = [];\n    this._error = false;\n    (this.host = host).addController(this);\n  }\n\n  private getMetaUrl(text: string) {\n    const div = document.createElement('div');\n    div.innerHTML = text;\n\n    const urlRegex = /(https?:\\/\\/[^ ]*)/;\n    const metaContent = (div.querySelector('meta[http-equiv=\"refresh\"]') as HTMLMetaElement)?.content ?? '';\n    const matches = metaContent.match(urlRegex);\n\n    if(!matches?.length) return;\n\n    return matches[1];\n  }\n\n  private async getDataFromMetaURL(text: string) {\n    const url = this.getMetaUrl(text);\n    if(!url) return;\n\n    const data = await fetch(url);\n\n    if (data.status === 409) {\n      await this.getTokens();\n      return;\n    }\n\n    if (!data.ok) {\n      throw Error('Query failed!');\n    }\n\n    this._token = data.url.split('/').pop() as string;\n    return await data.text();\n  }\n\n  private async getTokens() {\n    const data = await fetch('/checkout');\n\n    if (data.status === 409) {\n      await this.getTokens();\n      return;\n    }\n\n    if (!data.ok) {\n      throw Error('Query failed!');\n    }\n\n    const text = await data.text();\n    const div = document.createElement('div');\n    div.innerHTML = text;\n    const metaSelector = \"[name=shopify-checkout-authorization-token]\";\n    this._authorizationToken = (div.querySelector(metaSelector) as HTMLMetaElement)?.content ?? '';\n    this._token = data.url.split('/').pop() as string;\n\n    if (!this._authorizationToken) {\n      const text2 = await this.getDataFromMetaURL(text);\n      if(!text2) return;\n\n      const text3 = await this.getDataFromMetaURL(text2);\n      if(!text3) return;\n\n      const div2 = document.createElement('div');\n      div2.innerHTML = text3;\n      this._authorizationToken = (div2.querySelector(metaSelector) as HTMLMetaElement)?.content ?? '';\n    }\n  }\n\n  async queryCheckout(method=\"GET\", body:string|null=null) {\n    let data = await fetch(`/wallets/checkouts/${this._token}`, {\n      headers: {\n        accept: '*/*',\n        'content-type': 'application/json',\n        'x-shopify-checkout-authorization-token': this._authorizationToken\n      },\n      body,\n      method,\n      mode: 'cors',\n      credentials: 'include'\n    });\n\n    if (data.status === 409) {\n      data = await this.queryCheckout(method, body);\n    }\n\n    return data;\n  }\n\n  async clearDiscount(event: Event, code: string) {\n    const button = event.currentTarget as HTMLButtonElement;\n    button.classList.add('loading');\n\n    try {\n      const body = JSON.stringify({ checkout: { clear_discount: 1, discount_code: code } });\n      const data = await this.queryCheckout(\"PUT\", body);\n\n      if (!data.ok) {\n        throw Error('Operation failed!');\n      }\n\n      const JsonData = await data.json();\n      this._data = JsonData;\n\n      if (JsonData?.checkout?.applied_discounts) {\n        this._discounts = JsonData.checkout.applied_discounts;\n      }\n\n      if (JsonData?.checkout?.gift_cards) {\n        this._gift_cards = JsonData.checkout.gift_cards;\n      }\n\n      button.classList.remove('loading');\n      this.host.requestUpdate();\n    } catch (error) {\n      button.classList.remove('loading');\n      console.log(error)\n    }\n  }\n\n  async clearGiftCard(event: Event, giftCard: GiftCard) {\n    const button = event.currentTarget as HTMLButtonElement;\n    button.classList.add('loading');\n\n    try {\n      const body = JSON.stringify({\n        checkout: {\n          applied_gift_cards: {\n            [giftCard.id]: {\n              id: giftCard.id,\n              _delete: 1,\n            }\n          }\n        }\n      });\n\n      const data = await this.queryCheckout(\"PUT\", body);\n\n      if (!data.ok) {\n        throw Error('Operation failed!');\n      }\n\n      const JsonData = await data.json();\n      this._data = JsonData;\n\n      if (JsonData?.checkout?.applied_discounts) {\n        this._discounts = JsonData.checkout.applied_discounts;\n      }\n\n      if (JsonData?.checkout?.gift_cards) {\n        this._gift_cards = JsonData.checkout.gift_cards;\n      }\n\n      button.classList.remove('loading');\n      this.host.requestUpdate();\n    } catch (error) {\n      button.classList.remove('loading');\n      console.log(error)\n    }\n  }\n\n  async applyCode(code: string) {\n    const body = JSON.stringify({\n      checkout: {\n        reduction_code: code\n      }\n    });\n\n    const data = await this.queryCheckout(\"PUT\", body);\n\n    if (!data.ok) {\n      throw Error('Operation failed!');\n    }\n\n    const JsonData = await data.json();\n    this._data = JsonData;\n\n    if (JsonData?.checkout?.applied_discounts) {\n      this._discounts = JsonData.checkout.applied_discounts;\n    }\n\n    if (JsonData?.checkout?.gift_cards) {\n      this._gift_cards = JsonData.checkout.gift_cards;\n    }\n\n    this.host.requestUpdate();\n  }\n\n  private async discountQuery() {\n    try {\n      await this.getTokens();\n      const data = await this.queryCheckout();\n\n      if (data.status === 404) {\n        this._error = true;\n        return;\n      }\n\n      if (!data.ok) {\n        throw Error('Operation failed!');\n      }\n\n      const JsonData = await data.json();\n      this._data = JsonData;\n\n      if (JsonData?.checkout?.applied_discounts) {\n        this._discounts = JsonData.checkout.applied_discounts;\n      }\n  \n      if (JsonData?.checkout?.gift_cards) {\n        this._gift_cards = JsonData.checkout.gift_cards;\n      }\n    } catch (error) {\n      console.log(error);\n    }\n  }\n\n  async hostConnected() {\n    await this.discountQuery();\n    this.host.requestUpdate();\n\n    window.addEventListener('cart-updated', async () => {\n      await this.discountQuery();\n      this.host.requestUpdate();\n    });\n  }\n}\n"]}