{"version":3,"file":"data-controller.js","sourceRoot":"","sources":["src/data-controller.ts"],"names":[],"mappings":"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","sourcesContent":["import {ReactiveController, ReactiveControllerHost} from 'lit';\n\nexport interface GiftCard {\n  id: number,\n  last_characters: string,\n  balance: string,\n  amount_used: string,\n  presentment_amount_used: string,\n}\n\nexport interface CheckoutData {\n  checkout: {\n    applied_discounts: Array<{title: string}>,\n    gift_cards: Array<GiftCard>,\n    total_discount_amount: string\n  }\n}\n\nexport class DataController implements ReactiveController {\n  private host: ReactiveControllerHost;\n  _token: string;\n  _authorizationToken: string;\n  _data: CheckoutData;\n  _discounts: Array<{title: string}>;\n  _gift_cards: Array<GiftCard>;\n  _error: boolean;\n\n  constructor(host: ReactiveControllerHost) {\n    this._token = '';\n    this._authorizationToken = '';\n    this._data = {\n      checkout: {\n        applied_discounts: [],\n        gift_cards: [],\n        total_discount_amount: \"\",\n      }\n    };\n    this._discounts = [];\n    this._gift_cards = [];\n    this._error = false;\n    (this.host = host).addController(this);\n  }\n\n  private async getTokens() {\n    const data = await fetch('/checkout');\n    if (!data.ok) {\n      throw Error('Not ok status!');\n    }\n\n    const text = await data.text();\n    const div = document.createElement('div');\n    div.innerHTML = text;\n    const metaSelector = \"[name=shopify-checkout-authorization-token]\";\n    this._authorizationToken = (div.querySelector(metaSelector) as HTMLMetaElement)?.content ?? '';\n    this._token = data.url.split('/').pop() as string;\n  }\n\n  queryCheckout(method=\"GET\", body:string|null=null) {\n    return fetch(`/wallets/checkouts/${this._token}`, {\n      headers: {\n        accept: '*/*',\n        'content-type': 'application/json',\n        'x-shopify-checkout-authorization-token': this._authorizationToken\n      },\n      body,\n      method,\n      mode: 'cors',\n      credentials: 'omit'\n    });\n  }\n\n  async clearDiscount(event: Event, code: string) {\n    const button = event.currentTarget as HTMLButtonElement;\n    button.classList.add('loading');\n    console.log('%cTEST', 'color: orange; background: black; padding: 5px;', button);\n\n    try {\n      const body = JSON.stringify({ checkout: { clear_discount: 1, discount_code: code } });\n      const data = await this.queryCheckout(\"PUT\", body);\n\n      if (!data.ok) {\n        throw Error('Not ok status!');\n      }\n\n      const JsonData = await data.json();\n\n      if (JsonData?.checkout?.applied_discounts) {\n        this._discounts = JsonData.checkout.applied_discounts;\n      }\n\n      if (JsonData?.checkout?.gift_cards) {\n        this._gift_cards = JsonData.checkout.gift_cards;\n      }\n\n      button.classList.remove('loading');\n      this.host.requestUpdate();\n    } catch (error) {\n      button.classList.remove('loading');\n      console.log(error)\n    }\n  }\n\n  async clearGiftCard(event: Event, giftCard: GiftCard) {\n    const button = event.currentTarget as HTMLButtonElement;\n    button.classList.add('loading');\n    console.log('%cTEST', 'color: orange; background: black; padding: 5px;', button);\n\n    try {\n      const body = JSON.stringify({\n        checkout: {\n          applied_gift_cards: {\n            [giftCard.id]: {\n              id: giftCard.id,\n              _delete: 1,\n            }\n          }\n        }\n      });\n\n      const data = await this.queryCheckout(\"PUT\", body);\n\n      if (!data.ok) {\n        throw Error('Not ok status!');\n      }\n\n      const JsonData = await data.json();\n\n      if (JsonData?.checkout?.applied_discounts) {\n        this._discounts = JsonData.checkout.applied_discounts;\n      }\n\n      if (JsonData?.checkout?.gift_cards) {\n        this._gift_cards = JsonData.checkout.gift_cards;\n      }\n\n      this.host.requestUpdate();\n    } catch (error) {\n      console.log(error)\n    }\n  }\n\n  async applyCode(code: string) {\n    const body = JSON.stringify({\n      checkout: {\n        reduction_code: code\n      }\n    });\n\n    const data = await this.queryCheckout(\"PUT\", body);\n\n    if (!data.ok) {\n      throw Error('Not ok status!');\n    }\n\n    const JsonData = await data.json();\n\n    if (JsonData?.checkout?.applied_discounts) {\n      this._discounts = JsonData.checkout.applied_discounts;\n    }\n\n    if (JsonData?.checkout?.gift_cards) {\n      this._gift_cards = JsonData.checkout.gift_cards;\n    }\n\n    this.host.requestUpdate();\n  }\n\n  private async discountQuery() {\n    try {\n      await this.getTokens();\n      const data = await this.queryCheckout();\n\n      if (data.status === 404) {\n        throw Error('CART Empty! 404 status!');\n      }\n\n      if (!data.ok) {\n        throw Error('Not ok status!');\n      }\n\n      const JsonData = await data.json();\n\n      if (JsonData?.checkout?.applied_discounts) {\n        this._discounts = JsonData.checkout.applied_discounts;\n      }\n  \n      if (JsonData?.checkout?.gift_cards) {\n        this._gift_cards = JsonData.checkout.gift_cards;\n      }\n\n      this._data = JsonData;\n    } catch (error) {\n      console.log(error);\n      this._error = true;\n    }\n  }\n\n  async hostConnected() {\n    await this.discountQuery();\n    this.host.requestUpdate();\n  }\n}\n"]}