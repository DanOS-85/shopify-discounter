{"version":3,"file":"data-controler.js","sourceRoot":"","sources":["src/data-controler.ts"],"names":[],"mappings":"AAiBA,MAAM,OAAO,cAAc;IAQzB,YAAY,IAA4B,EAAE,KAAa;QACrD,CAAC,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC;QACvC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QACpB,IAAI,CAAC,MAAM,GAAG,EAAE,CAAC;QACjB,IAAI,CAAC,mBAAmB,GAAG,EAAE,CAAC;QAC9B,IAAI,CAAC,KAAK,GAAG;YACX,QAAQ,EAAE;gBACR,iBAAiB,EAAE,EAAE;gBACrB,UAAU,EAAE,EAAE;aACf;SACF,CAAC;QACF,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;IACtB,CAAC;IAEO,KAAK,CAAC,SAAS;;QACrB,MAAM,IAAI,GAAG,MAAM,KAAK,CAAC,WAAW,IAAI,CAAC,MAAM,WAAW,CAAC,CAAC;QAC5D,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;QAC/B,MAAM,GAAG,GAAG,QAAQ,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QAC1C,GAAG,CAAC,SAAS,GAAG,IAAI,CAAC;QACrB,MAAM,YAAY,GAAG,6CAA6C,CAAC;QACnE,IAAI,CAAC,mBAAmB,GAAG,MAAA,MAAC,GAAG,CAAC,aAAa,CAAC,YAAY,CAAqB,0CAAE,OAAO,mCAAI,EAAE,CAAC;QAC/F,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,GAAG,EAAY,CAAC;IACpD,CAAC;IAED,aAAa,CAAC,MAAM,GAAC,KAAK,EAAE,OAAiB,IAAI;QAC/C,OAAO,KAAK,CAAC,WAAW,IAAI,CAAC,MAAM,sBAAsB,IAAI,CAAC,MAAM,EAAE,EAAE;YACtE,OAAO,EAAE;gBACP,MAAM,EAAE,KAAK;gBACb,cAAc,EAAE,kBAAkB;gBAClC,wCAAwC,EAAE,IAAI,CAAC,mBAAmB;aACnE;YACD,IAAI;YACJ,MAAM;YACN,IAAI,EAAE,MAAM;YACZ,WAAW,EAAE,MAAM;SACpB,CAAC,CAAC;IACL,CAAC;IAEO,KAAK,CAAC,aAAa;QACzB,IAAI;YACF,MAAM,IAAI,CAAC,SAAS,EAAE,CAAC;YACvB,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,aAAa,EAAE,CAAC;YAExC,IAAI,IAAI,CAAC,MAAM,KAAK,GAAG,EAAE;gBACvB,MAAM,KAAK,CAAC,yBAAyB,CAAC,CAAC;aACxC;YAED,IAAI,CAAC,IAAI,CAAC,EAAE,EAAE;gBACZ,MAAM,KAAK,CAAC,gBAAgB,CAAC,CAAC;aAC/B;YAED,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,IAAI,EAAE,CAAC;YAEnC,IAAI,CAAC,KAAK,GAAG,QAAQ,CAAC;SACvB;QAAC,OAAO,KAAK,EAAE;YACd,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;YACnB,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC;SACpB;IACH,CAAC;IAED,KAAK,CAAC,aAAa;QACjB,MAAM,IAAI,CAAC,aAAa,EAAE,CAAC;QAC3B,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC;IAC5B,CAAC;CACF","sourcesContent":["import {ReactiveController, ReactiveControllerHost} from 'lit';\n\nexport interface GiftCard {\n  \"id\": number,\n  \"last_characters\": string,\n  \"balance\": string,\n  \"amount_used\": string,\n  \"presentment_amount_used\": string,\n}\n\ninterface CheckoutData {\n  checkout: {\n    applied_discounts: Array<{title: string}>,\n    gift_cards: Array<GiftCard>\n  }\n}\n\nexport class DataController implements ReactiveController {\n  private host: ReactiveControllerHost;\n  private _store: string;\n  _token: string;\n  _authorizationToken: string;\n  _data: CheckoutData;\n  _error: boolean;\n\n  constructor(host: ReactiveControllerHost, store: string) {\n    (this.host = host).addController(this);\n    this._store = store;\n    this._token = '';\n    this._authorizationToken = '';\n    this._data = {\n      checkout: {\n        applied_discounts: [],\n        gift_cards: []\n      }\n    };\n    this._error = false;\n  }\n\n  private async getTokens() {\n    const data = await fetch(`https://${this._store}/checkout`);\n    const text = await data.text();\n    const div = document.createElement('div');\n    div.innerHTML = text;\n    const metaSelector = \"[name=shopify-checkout-authorization-token]\";\n    this._authorizationToken = (div.querySelector(metaSelector) as HTMLMetaElement)?.content ?? '';\n    this._token = data.url.split('/').pop() as string;\n  }\n\n  queryCheckout(method=\"GET\", body:string|null=null) {\n    return fetch(`https://${this._store}/wallets/checkouts/${this._token}`, {\n      headers: {\n        accept: '*/*',\n        'content-type': 'application/json',\n        'x-shopify-checkout-authorization-token': this._authorizationToken\n      },\n      body,\n      method,\n      mode: 'cors',\n      credentials: 'omit'\n    });\n  }\n\n  private async discountQuery() {\n    try {\n      await this.getTokens();\n      const data = await this.queryCheckout();\n\n      if (data.status === 404) {\n        throw Error('CART Empty! 404 status!');\n      }\n\n      if (!data.ok) {\n        throw Error('Not ok status!');\n      }\n\n      const JsonData = await data.json();\n\n      this._data = JsonData;\n    } catch (error) {\n      console.log(error);\n      this._error = true;\n    }\n  }\n\n  async hostConnected() {\n    await this.discountQuery();\n    this.host.requestUpdate();\n  }\n}\n"]}